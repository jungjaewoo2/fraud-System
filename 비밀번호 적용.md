# Spring Boot BCrypt 비밀번호 적용 가이드

## 📋 목차
1. [문제점 분석](#문제점-분석)
2. [해결 과정](#해결-과정)
3. [올바른 BCrypt 적용 방법](#올바른-bcrypt-적용-방법)
4. [개발 시 주의사항](#개발-시-주의사항)
5. [디버깅 방법](#디버깅-방법)
6. [베스트 프랙티스](#베스트-프랙티스)

---

## 🔍 문제점 분析

### 발생한 문제
- **증상**: `admin` / `123` 로그인 시 "Bad credentials" 오류 발생
- **원인**: 데이터베이스에 저장된 BCrypt 해시가 실제 패스워드와 일치하지 않음
- **로그**: `Failed to authenticate since password does not match stored value`

### 문제 원인
```sql
-- 잘못된 해시 (실제로는 "123"이 아닌 다른 패스워드의 해시)
$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDi

-- 올바른 "123" 패스워드의 해시
$2a$10$luGYwvjsjHftusxnFJdDHegkYK.ubWP20iiB.uZ5S01Vr.QbVmB7m
```

---

## 🛠️ 해결 과정

### 1단계: 디버깅 환경 구성
```java
// AdminService.java - 패스워드 매칭 테스트 메소드 추가
public void testPasswordMatching(String username, String inputPassword) {
    logger.info("=== 패스워드 매칭 테스트 시작 ===");
    logger.info("입력된 사용자명: {}", username);
    logger.info("입력된 패스워드: {}", inputPassword);
    
    Admin admin = findByUsername(username);
    if (admin != null) {
        logger.info("데이터베이스에서 조회된 패스워드 해시: {}", admin.getPassword());
        
        // 직접 BCrypt 매칭 테스트
        boolean matches = passwordEncoder.matches(inputPassword, admin.getPassword());
        logger.info("BCrypt 매칭 결과: {}", matches);
        
        // 새로운 해시 생성 테스트
        String newHash = passwordEncoder.encode(inputPassword);
        logger.info("입력된 패스워드로 생성된 새로운 해시: {}", newHash);
        
        // 새 해시와 입력 패스워드 매칭 테스트
        boolean newMatches = passwordEncoder.matches(inputPassword, newHash);
        logger.info("새 해시와 입력 패스워드 매칭 결과: {}", newMatches);
    }
    logger.info("=== 패스워드 매칭 테스트 완료 ===");
}
```

### 2단계: 테스트 엔드포인트 생성
```java
// AdminController.java - 테스트 엔드포인트 추가
@GetMapping("/test-password")
@ResponseBody
public String testPassword() {
    adminService.testPasswordMatching("admin", "123");
    return "패스워드 테스트 완료 - 로그 확인하세요";
}
```

### 3단계: SecurityConfig 수정
```java
// SecurityConfig.java - 테스트 엔드포인트 접근 허용
.requestMatchers("/admin/test-password").permitAll()
```

### 4단계: 올바른 해시로 교체
```sql
-- data.sql - 올바른 BCrypt 해시로 업데이트
UPDATE admin SET password = '$2a$10$luGYwvjsjHftusxnFJdDHegkYK.ubWP20iiB.uZ5S01Vr.QbVmB7m', updated_at = NOW() WHERE username = 'admin';
```

---

## ✅ 올바른 BCrypt 적용 방법

### 1. PasswordEncoder Bean 설정
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### 2. CustomUserDetailsService 구현
```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private AdminRepository adminRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Admin admin = adminRepository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException("사용자를 찾을 수 없습니다: " + username));
        
        return new User(
                admin.getUsername(),
                admin.getPassword(), // 데이터베이스의 BCrypt 해시
                true, true, true, true,
                List.of(new SimpleGrantedAuthority("ROLE_ADMIN"))
        );
    }
}
```

### 3. 올바른 BCrypt 해시 생성 방법

#### 방법 1: 애플리케이션 코드로 생성
```java
@Component
public class PasswordHashGenerator {
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    public void generateHash() {
        String password = "123";
        String hash = passwordEncoder.encode(password);
        System.out.println("Password: " + password);
        System.out.println("BCrypt Hash: " + hash);
    }
}
```

#### 방법 2: 온라인 BCrypt 생성기 사용
- **추천 사이트**: https://bcrypt-generator.com/
- **주의사항**: Rounds는 10-12 사용 권장

#### 방법 3: 테스트 코드로 생성
```java
@Test
public void generateBCryptHash() {
    BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
    String password = "admin123";
    String hash = encoder.encode(password);
    
    System.out.println("Password: " + password);
    System.out.println("BCrypt Hash: " + hash);
    
    // 검증
    assertTrue(encoder.matches(password, hash));
}
```

---

## ⚠️ 개발 시 주의사항

### 1. 초기 데이터 설정
```sql
-- ❌ 잘못된 방법: 평문 패스워드 저장
INSERT INTO admin (username, password) VALUES ('admin', '123');

-- ✅ 올바른 방법: BCrypt 해시 저장
INSERT INTO admin (username, password) VALUES ('admin', '$2a$10$올바른BCrypt해시');
```

### 2. 패스워드 변경 시
```java
// AdminService.java
public void changePassword(String username, String newPassword) {
    Admin admin = findByUsername(username);
    if (admin != null) {
        // ✅ 새 패스워드를 BCrypt로 암호화하여 저장
        admin.setPassword(passwordEncoder.encode(newPassword));
        adminRepository.save(admin);
    }
}
```

### 3. 인증 과정에서 주의사항
```java
// ❌ 잘못된 방법: 평문 비교
if (inputPassword.equals(admin.getPassword())) {
    // 인증 성공
}

// ✅ 올바른 방법: BCrypt 매칭
if (passwordEncoder.matches(inputPassword, admin.getPassword())) {
    // 인증 성공
}
```

---

## 🔧 디버깅 방법

### 1. 로깅 설정
```xml
<!-- logback-spring.xml -->
<logger name="com.yourpackage.service" level="DEBUG"/>
<logger name="org.springframework.security" level="DEBUG"/>
```

### 2. 패스워드 매칭 테스트
```java
// 디버깅용 메소드
public void debugPasswordMatching(String inputPassword, String storedHash) {
    logger.info("입력 패스워드: {}", inputPassword);
    logger.info("저장된 해시: {}", storedHash);
    
    boolean matches = passwordEncoder.matches(inputPassword, storedHash);
    logger.info("매칭 결과: {}", matches);
    
    if (!matches) {
        String newHash = passwordEncoder.encode(inputPassword);
        logger.info("올바른 해시: {}", newHash);
    }
}
```

### 3. 일반적인 오류 패턴
```
Failed to authenticate since password does not match stored value
→ BCrypt 해시가 올바르지 않음

UsernameNotFoundException: 사용자를 찾을 수 없습니다
→ 사용자명이 데이터베이스에 없음

Bad credentials
→ 패스워드 불일치 또는 사용자 없음
```

---

## 🏆 베스트 프랙티스

### 1. 개발 환경 설정
```properties
# application-dev.properties
logging.level.com.yourpackage=DEBUG
logging.level.org.springframework.security=DEBUG

# 개발용 기본 계정 설정
app.admin.username=admin
app.admin.password=dev123
```

### 2. 초기 데이터 생성 전략
```java
@Component
public class DataInitializer {
    
    @Autowired
    private AdminRepository adminRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @PostConstruct
    public void initializeData() {
        if (!adminRepository.existsByUsername("admin")) {
            Admin admin = new Admin();
            admin.setUsername("admin");
            admin.setPassword(passwordEncoder.encode("123"));
            adminRepository.save(admin);
            
            logger.info("기본 관리자 계정 생성 완료");
        }
    }
}
```

### 3. 패스워드 정책 적용
```java
@Component
public class PasswordValidator {
    
    public boolean isValidPassword(String password) {
        return password != null 
            && password.length() >= 8
            && password.matches(".*[A-Z].*")  // 대문자 포함
            && password.matches(".*[a-z].*")  // 소문자 포함
            && password.matches(".*[0-9].*")  // 숫자 포함
            && password.matches(".*[!@#$%^&*()].*"); // 특수문자 포함
    }
}
```

### 4. 보안 강화
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // BCrypt 강도 설정 (기본값: 10, 권장: 10-12)
        return new BCryptPasswordEncoder(12);
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .sessionManagement(session -> session
                .maximumSessions(1) // 동시 세션 제한
                .maxSessionsPreventsLogin(false)
            )
            .rememberMe(remember -> remember
                .tokenValiditySeconds(86400) // 24시간
                .userDetailsService(customUserDetailsService)
            );
        
        return http.build();
    }
}
```

---

## 📚 참고 자료

### BCrypt 관련
- [Spring Security BCrypt 공식 문서](https://docs.spring.io/spring-security/reference/features/authentication/password-storage.html#authentication-password-storage-bcrypt)
- [BCrypt 온라인 생성기](https://bcrypt-generator.com/)
- [BCrypt 강도 설정 가이드](https://security.stackexchange.com/questions/17207/recommended-of-rounds-for-bcrypt)

### Spring Security 관련
- [Spring Security 공식 문서](https://docs.spring.io/spring-security/reference/index.html)
- [UserDetailsService 구현 가이드](https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/user-details-service.html)

---

## 🎯 체크리스트

### 개발 시작 전
- [ ] PasswordEncoder Bean 설정 확인
- [ ] CustomUserDetailsService 구현
- [ ] 초기 관리자 계정 BCrypt 해시 생성
- [ ] SecurityConfig 설정 확인

### 개발 중
- [ ] 패스워드 저장 시 BCrypt 암호화 적용
- [ ] 패스워드 비교 시 matches() 메소드 사용
- [ ] 로깅 설정으로 디버깅 환경 구축

### 배포 전
- [ ] 기본 패스워드 변경
- [ ] 패스워드 정책 적용
- [ ] 보안 설정 점검
- [ ] 로그인 테스트 완료

---

**작성일**: 2025-09-14  
**프로젝트**: 상품권 부정방지 시스템  
**작성자**: AI Assistant
